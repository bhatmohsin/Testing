<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes Search</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        select, input, button { margin: 10px 0; padding: 5px; }
        #results { margin-top: 20px; }
        .file-item { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        #loading { display: none; }
    </style>
</head>
<body>
    <h1>Notes Search</h1>
    <select id="semester">
        <option value="">Select Semester</option>
        <!-- Options will be populated dynamically -->
    </select>
    <input type="text" id="subject" placeholder="Enter subject">
    <button onclick="searchNotes()">Search</button>
    <div id="loading">Loading...</div>
    <div id="results"></div>

    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        let folderStructure = null;
        let fileMetadataCache = {};

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }, function(error) {
                console.error('Error initializing Google API client', error);
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                loadFolderStructure();
            } else {
                gapi.auth2.getAuthInstance().signIn();
            }
        }

        async function loadFolderStructure() {
            try {
                const rootFolderId = 'YOUR_ROOT_FOLDER_ID'; // Replace with your "notes" folder ID
                folderStructure = await getFolderContents(rootFolderId);
                populateSemesters();
            } catch (error) {
                console.error('Error loading folder structure', error);
            }
        }

        async function getFolderContents(folderId) {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and mimeType = 'application/vnd.google-apps.folder'`,
                fields: 'files(id, name)'
            });
            return response.result.files;
        }

        function populateSemesters() {
            const semesterSelect = document.getElementById('semester');
            folderStructure.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                semesterSelect.appendChild(option);
            });
        }

        async function searchNotes() {
            const semesterId = document.getElementById('semester').value;
            const subject = document.getElementById('subject').value.toLowerCase();
            
            if (!semesterId || !subject) {
                alert('Please select a semester and enter a subject');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';

            try {
                const semesterFolders = await getFolderContents(semesterId);
                const subjectFolder = semesterFolders.find(folder => folder.name.toLowerCase().includes(subject));
                
                if (subjectFolder) {
                    const files = await getFiles(subjectFolder.id);
                    displayResults(files);
                } else {
                    document.getElementById('results').innerHTML = 'No matching subject folder found';
                }
            } catch (error) {
                console.error('Error searching notes', error);
                document.getElementById('results').innerHTML = 'An error occurred while searching';
            }

            document.getElementById('loading').style.display = 'none';
        }

        async function getFiles(folderId) {
            if (fileMetadataCache[folderId]) {
                return fileMetadataCache[folderId];
            }

            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and mimeType != 'application/vnd.google-apps.folder'`,
                fields: 'files(id, name, mimeType, webViewLink, size)'
            });

            fileMetadataCache[folderId] = response.result.files;
            return response.result.files;
        }

        function displayResults(files) {
            const resultsDiv = document.getElementById('results');
            if (files.length === 0) {
                resultsDiv.innerHTML = 'No files found';
                return;
            }

            const fileList = files.map(file => `
                <div class="file-item">
                    <h3>${file.name}</h3>
                    <p>Size: ${formatFileSize(file.size)}</p>
                    <a href="${file.webViewLink}" target="_blank">View File</a>
                </div>
            `).join('');

            resultsDiv.innerHTML = fileList;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        gapi.load('client:auth2', initClient);
    </script>
</body>
</html>
